generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // Link Render của bạn (Đã OK)
  url      = "postgresql://admin:tSndYBoIuRYTQk38ZQZMOyjmBJQNBWzm@dpg-d58g5gali9vc73a203tg-a.singapore-postgres.render.com/safetrek_db"
}

// --- BẮT ĐẦU CÁC BẢNG (ĐÃ CẬP NHẬT OTP) ---

model User {
  userId        Int      @id @default(autoincrement()) @map("user_id")
  
  // Sửa: Cho phép null và Unique
  phoneNumber   String?  @unique @map("phone_number") @db.VarChar(20)
  email         String?  @unique @db.VarChar(100)
  
  fullName      String?   @map("full_name") @db.VarChar(100)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(255)
  passwordHash  String?   @map("password_hash") @db.VarChar(255)
  safePinHash   String?   @map("safe_pin_hash") @db.VarChar(255)
  duressPinHash String?   @map("duress_pin_hash") @db.VarChar(255)

  // THÊM MỚI: 2 trường này bắt buộc phải có để chạy Login OTP
  otpCode       String?   @map("otp_code") @db.VarChar(10)
  otpExpiry     DateTime? @map("otp_expiry")

  lastKnownLat  Decimal?  @map("last_known_lat") @db.Decimal(10, 8)
  lastKnownLng  Decimal?  @map("last_known_lng") @db.Decimal(11, 8)
  lastBattery   Int?      @map("last_battery_level") @db.SmallInt
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp()

  guardians     Guardian[]
  trips         Trip[]
  alerts        Alert[]

  @@map("users")
}

model Guardian {
  guardianId    Int            @id @default(autoincrement()) @map("guardian_id")
  userId        Int            @map("user_id")
  guardianName  String         @map("guardian_name") @db.VarChar(100)
  guardianPhone String         @map("guardian_phone") @db.VarChar(20)
  relationship  String?        @db.VarChar(50)
  status        GuardianStatus @default(PENDING)
  user          User           @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, guardianPhone])
  @@map("guardians")
}

model Trip {
  tripId          Int          @id @default(autoincrement()) @map("trip_id")
  userId          Int          @map("user_id")
  destinationName String?      @map("destination_name")
  destinationLat  Decimal?     @map("destination_lat") @db.Decimal(10, 8)
  destinationLng  Decimal?     @map("destination_lng") @db.Decimal(11, 8)
  durationMinutes Int          @map("expected_duration_minutes")
  expectedEndTime DateTime     @map("expected_end_time") @db.Timestamp()
  status          TripStatus   @default(ACTIVE)
  user            User         @relation(fields: [userId], references: [userId])
  locations       TripLocation[]
  alerts          Alert[]

  @@map("trips")
}

model TripLocation {
  logId      BigInt   @id @default(autoincrement()) @map("log_id")
  tripId     Int      @map("trip_id")
  lat        Decimal  @db.Decimal(10, 8)
  lng        Decimal  @db.Decimal(11, 8)
  recordedAt DateTime @default(now()) @map("recorded_at") @db.Timestamp()
  trip       Trip     @relation(fields: [tripId], references: [tripId], onDelete: Cascade)

  @@map("trip_locations")
}

model Alert {
  alertId   Int       @id @default(autoincrement()) @map("alert_id")
  userId    Int       @map("user_id")
  tripId    Int?      @map("trip_id")
  alertType AlertType @map("alert_type")
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp()
  user      User      @relation(fields: [userId], references: [userId])
  trip      Trip?     @relation(fields: [tripId], references: [tripId])

  @@map("alerts")
}

enum GuardianStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum TripStatus {
  ACTIVE
  COMPLETED_SAFE
  TIMED_OUT
  DURESS_ENDED
  PANIC_ENDED
}

enum AlertType {
  TIMEOUT
  PANIC_BUTTON
  DURESS_PIN
}